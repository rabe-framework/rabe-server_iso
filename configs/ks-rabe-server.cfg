#Generated by Kickstart Configurator
#platform=AMD64 or Intel EM64T

#System language
lang en_US
#Language modules to install
langsupport en_US
#System keyboard
keyboard us_intl
#System mouse
mouse
#System timezone
timezone Europe/Amsterdam
#Root password
rootpw --disabled
#Initial user
user rabe-admin --fullname "rabe-admin" --iscrypted --password $1$S7J.8kyT$egc9s6cLE9ZAUPhs3pxZL1
#Reboot after installation
reboot
#Use text mode install
text
#Install OS instead of upgrade
install
#Use CDROM installation media
cdrom
#System bootloader configuration
bootloader --location=mbr 
#Clear the Master Boot Record
zerombr yes
#Partition clearing information
clearpart --all --initlabel 
#System authorization infomation
auth  --useshadow  --enablemd5 
#Network information
network --bootproto=dhcp --device=eth0
#Firewall configuration
firewall --enabled 
#Do not configure the X Window System
skipx
%post --interpreter /bin/bash

# copy rabe files
#mkdir -p /mnt/cdrom/
#mount /dev/cdrom/ /mnt/cdrom/

# easy-rsa: create 'rabe-server' certificates and keys
mkdir -p /home/rabe-admin/easy-rsa/
cd /home/rabe-admin/easy-rsa/
cp -r /usr/share/easy-rsa/* .
sed -i 's/subjectAltName=/#subjectAltName=/g' openssl-1.0.0.cnf
sed -i 's/CA_EXPIRE=3650/CA_EXPIRE=365/g' vars
sed -i 's/KEY_EXPIRE=3650/KEY_EXPIRE=365/g' vars
sed -i 's/KEY_COUNTRY="US"/KEY_COUNTRY="NL"/g' vars
sed -i 's/KEY_PROVINCE="CA"/KEY_PROVINCE="ZH"/g' vars
sed -i 's/KEY_CITY="SanFrancisco"/KEY_CITY="Den Haag"/g' vars
sed -i 's/KEY_ORG="Fort-Funston"/KEY_ORG="Netherlands Forensic Institute"/g' vars
sed -i 's/KEY_EMAIL="me@myhost.mydomain"/KEY_EMAIL="rabeframework@gmail.com"/g' vars
sed -i 's/KEY_OU="MyOrganizationalUnit"/KEY_OU="Digital Technology and Biometry"/g' vars
sed -i 's/KEY_NAME="EasyRSA"/KEY_NAME="Remote Acquisition Boot Environment (RABE) server"/g' vars
source vars
./clean-all
./build-ca --batch
./build-key-server --batch rabe-server
./build-dh
cd /home/rabe-admin/easy-rsa/keys
cp ca.crt /etc/openvpn/
mv dh2048.pem rabe-server.crt rabe-server.key /etc/openvpn/

# openvpn: add 'rabe-server' settings
cp /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz /etc/openvpn/
gzip -d /etc/openvpn/server.conf.gz
cp /etc/openvpn/server.conf /etc/openvpn/rabe-server.conf
sed -i 's/;proto tcp/proto tcp/g' /etc/openvpn/rabe-server.conf
sed -i 's/proto udp/;proto udp/g' /etc/openvpn/rabe-server.conf
sed -i 's/server.crt/rabe-server.crt/g' /etc/openvpn/rabe-server.conf
sed -i 's/server.key/rabe-server.key/g' /etc/openvpn/rabe-server.conf
sed -i 's/dh1024.pem/dh2048.pem/g' /etc/openvpn/rabe-server.conf
sed -i 's/;duplicate-cn/duplicate-cn/g' /etc/openvpn/rabe-server.conf
sed -i 's/;cipher AES-128-CBC/cipher AES-256-CBC/g' /etc/openvpn/rabe-server.conf
sed -i 's/comp-lzo/;comp-lzo/g' /etc/openvpn/rabe-server.conf
sed -i 's/;log-append	openvpn.log/log-append	openvpn.log/g' /etc/openvpn/rabe-server.conf
echo -e "\n# Additional settings: key size and authentication algorithm." >> /etc/openvpn/rabe-server.conf
echo "keysize 256" >> /etc/openvpn/rabe-server.conf
echo "auth SHA256" >> /etc/openvpn/rabe-server.conf

# openvpn: add 'rabe-server' autostart
sed -i 's/#AUTOSTART="none"/AUTOSTART="rabe-server"/g' /etc/default/openvpn